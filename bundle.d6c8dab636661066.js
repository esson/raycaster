(()=>{"use strict";class t{constructor(e,i){e instanceof t&&(i=e.y,e=e.x),"number"!=typeof i&&(i=e),this.x=e,this.y=i}add(t,e){return this.operate(t,e,"+")}subtract(t,e){return this.operate(t,e,"-")}multiply(t,e){return this.operate(t,e,"*")}divide(t,e){return this.operate(t,e,"/")}operate(e,i,o){switch(e instanceof t&&(i=e.y,e=e.x),"number"!=typeof i&&(i=e),o){case"+":return new t(this.x+e,this.y+i);case"-":return new t(this.x-e,this.y-i);case"*":return new t(this.x*e,this.y*i);case"/":return new t(this.x/e,this.y/i)}}distance(e){return t.distance(this.x,this.y,e.x,e.y)}toArray(){return[this.x,this.y]}static distance(t,e,i,o){return Math.sqrt(Math.pow(i-t,2)+Math.pow(o-e,2))}}function e(e,i=16,o=65){return new t(e%i,Math.floor(e/i)).multiply(o)}function i(t,e=!1,i=!1){return i?(e,i)=>e.split("").map(((e,o)=>" "===e||"-"===e?void 0:{...t[e],x:parseInt(o)+.5,y:i+.5})):e?e=>e.split("").map((e=>" "===e||"-"===e?void 0:t[e])):e=>e.split("").map((e=>" "===e||"-"===e?void 0:{...t[e]}))}const o=function(){const o={1:{color:"#797979",darkColor:"#616161",sprite:0,darkSprite:1},2:{color:"#09096f",darkColor:"#070759",sprite:14,darkSprite:15},3:{color:"#604220",darkColor:"#4d351a",sprite:22,darkSprite:23},4:{color:"#09096f",darkColor:"#070759",sprite:8,darkSprite:9},5:{color:"#09096f",darkColor:"#070759",sprite:12,darkSprite:13},6:{color:"#797979",darkColor:"#616161",sprite:10,darkSprite:11},7:{color:"#797979",darkColor:"#616161",sprite:6,darkSprite:7},8:{color:"#797979",darkColor:"#616161",sprite:4,darkSprite:5},9:{color:"#604220",darkColor:"#4d351a",sprite:18,darkSprite:19},a:{color:"#797979",darkColor:"#616161",sprite:41,darkSprite:41,next:"b"},b:{color:"#797979",darkColor:"#616161",sprite:43,darkSprite:43,next:"a"},c:{color:"#604220",darkColor:"#4d351a",sprite:20,darkSprite:21},e:{color:"#797979",darkColor:"#616161",sprite:40,darkSprite:40}};for(const t in o)if(Object.hasOwnProperty.call(o,t)){const e=o[t];e.next&&(e.next=o[e.next])}const r={1:{color:"#00a4a4",darkColor:"#297979",sprite:98,darkSprite:99,frameColor:"#00a4a4",frameDarkColor:"#297979",frameSprite:100,frameDarkSprite:101,action:2,position:0,ticks:0},2:{color:"#cccccc",darkColor:"#dddddd",sprite:102,darkSprite:103,frameColor:"#cccccc",frameDarkColor:"#dddddd",frameSprite:100,frameDarkSprite:101,action:2,position:0,ticks:0}},a={1:{sprite:116,solid:!0},2:{sprite:122},3:{sprite:201},4:{sprite:127},5:{sprite:117},6:{sprite:112},7:{sprite:119,solid:!0},8:{sprite:120,solid:!0},9:{sprite:124,solid:!0},a:{sprite:110,solid:!0},b:{sprite:111,solid:!0},c:{sprite:147,solid:!0},d:{sprite:143,solid:!0},e:{sprite:109,solid:!0},f:{sprite:108},g:{sprite:145,solid:!0},h:{sprite:144,solid:!0},i:{sprite:121,solid:!0},j:{sprite:131}};return Object.keys(o).map((t=>o[t])).forEach((t=>t.sprite=e(t.sprite))),Object.keys(o).map((t=>o[t])).forEach((t=>t.darkSprite=e(t.darkSprite))),Object.keys(r).map((t=>r[t])).forEach((t=>t.sprite=e(t.sprite))),Object.keys(r).map((t=>r[t])).forEach((t=>t.darkSprite=e(t.darkSprite))),Object.keys(r).map((t=>r[t])).forEach((t=>t.frameSprite=e(t.frameSprite))),Object.keys(r).map((t=>r[t])).forEach((t=>t.frameDarkSprite=e(t.frameDarkSprite))),Object.keys(a).map((t=>a[t])).forEach((t=>t.sprite=e(t.sprite))),{spawn:new t(29,50).add(.5),ceiling:"#383838",floor:"#707070",walls:["                            3339333339333                      ","     111111                 3           3                      ","     1    1      111111181119           93333                  ","     1    1      1          3           3   3                  ","     1     1     1                          9                  ","     1     1     1          3           3   3                  ","     11611 11611 1   1118111c           c3333                  ","     1         1 1   1      3           3                      ","     8         811   111     33933 339333                      ","     1         1       1        3   3                          ","     1                 1        3   3                          ","     1         1       1        c   c                          ","111118         811161111        3   3                          ","1   11         1                3   3                          ","1   111611 1161            333333   333                        ","1   1   1   1              3          3                        ","11 11   8   8              3  333   333                        ","1   11111   1              3  333   3                          ","1   1   1   1              3  333   3                          ","1       8   8              333339   9                          ","1   1   1   1                   3   3                          ","1   111111 11111                39 93                2222222222","8   81         1          111181     1811111         2        2","1   11         8          1               11         2        2","1   11         1          6               622222222222        2","1    1         1          1                2         2        2","1              8          1                                   4","1    1         1          1                2         2        2","1   11         1          6               6222    2222        2","1   11         8          1               11122  2   2        2","1   11         1          117111     111711   2  2   2        2","7   711111 11111               122 22         2  2   222 22 222","1   11111   1                   2   2         2  2      2  2   ","1   11111   1                   2   2         2  2             ","1   1   1   1                   2   2         2  2  2 2 2 2    ","1       8   8                   2   2         2  222 2 2 2 22  ","1   1   1   1                   2   2         2   2         2  ","1   11111   1                   2   2         2             4  ","1   11111   1111111116111       2   2         2   2         2  ","1                1      8e1     2   2         222222 2 2 2 22  ","1                         a     2   2               2 2 2 2    ","1                1      8e1     2   2                          ","111111111171111111 116111       2   2                          ","          e8  1     1      2222222 2222222                     ","         a    1  1 1       2    2   2    2                     ","          e8     11        2             2                     ","            1 1111         2    2   2    2                     ","            1  1           2    2   2    2                     ","            1  1           222222   222222                     ","            1111           2    2   2    2                     ","                           2             2                     ","                           2    2   2    2                     ","                           222222   222222                     ","                           2             2                     ","                           2             2                     ","                           2             2                     ","                           242242252242242                     "].map(i(o,!0)),pushWalls:["                            -------------                      ","     ------                 -           -                      ","     -    -      ------------           -----                  ","     -    -      -          -           -   -                  ","     -     -     -                          -                  ","     -     -     -          -           -   -                  ","     -----7----- -   --------           -----                  ","     -         - -   -      -           -                      ","     -         ---   ---     ----- ------                      ","     -         -       -        -   -                          ","     -                 -        -   -                          ","     -         -       -        -   -                          ","------         ---------        -   -                          ","-   --         -                -   -                          ","-   ------ ----            ------   ---                        ","-   -   -   -              -  9       -                        ","-- --   -   -              -  ---   ---                        ","-   -----   -              -  ---   -                          ","-   -   -   -              -  ---   -                          ","-       -   -              ------   -                          ","-   -   -   -                   -   -                          ","-   ------ -----                -- --                ----------","-   --         -          ------     -------         -        -","-   --         -          -               --         -        -","-   --         -          -               ------------        -","-    -         -          -                -         -        -","-              -          -                                   -","-    -         -          -                -         -        -","-   --         -          -               ----    ----        -","-   --         -          -               -----  -   -        -","-   --         -          ------     ------   -  -   -        -","-   ------ -----               --- --         -  -   --- -- ---","-   -----   -                   -   -         -  -      -  -   ","-   -----   -                   -   -         -  -             ","-   -   -   -                   -   -         -  -  - - - -    ","-       -   -                   -   -         -  --- - - - --  ","-   -   -   -                   -   -         -   -         -  ","-   -----   -                   -   -         -             -  ","-   -----   -------------       -   -         -   -         -  ","-                -      ---     -   -         ------ - - - --  ","-                         -     -   -               - - - -    ","-                -      ---     -   -                          ","------------------1------       -   -                          ","          --  -  1  -      ------- -------                     ","         -    -  - -       -    -   -    -                     ","          --     --        -             -                     ","            -1----         -    -   -    -                     ","            -  -           -    -   -    -                     ","            -  -           ------   ------                     ","            ----           -    -   -    -                     ","                           -             -                     ","                           -    -   -    -                     ","                           ------   ------                     ","                           -             -                     ","                           -             -                     ","                           -             -                     ","                           ---------------                     "].map(i(o,!1)).map(((t,e)=>t.map(((t,e)=>(t&&(t.action=0,t.position=0,t.dirX=0,t.dirY=0),t))))),doors:["                            -------------                      ","     ------                 -           -                      ","     -    -      ------------           -----                  ","     -    -      -          -           -   -                  ","     -     -     -          1           1   -                  ","     -     -     -          -           -   -                  ","     ----- ----- -   --------           -----                  ","     -         - -   -      -           -                      ","     -         ---   ---     -----1------                      ","     -         -       -        -   -                          ","     -         1       -        -   -                          ","     -         -       -        -   -                          ","------         ---------        -   -                          ","-   --         -                -   -                          ","-   ------1----            ------   ---                        ","-   -   -   -              -          -                        ","--1--   -   -              -  ---   ---                        ","-   -----   -              -  ---   -                          ","-   -   -   -              -  ---   -                          ","-       -   -              ------   -                          ","-   -   -   -                   -   -                          ","-   ------1-----                --1--                ----------","-   --         -          ------     -------         -        -","-   --         -          -               --         -        -","-   --         -          -               ------------        -","-    -         -          -                -         -        -","-    1         -          -                1         1        -","-    -         -          -                -         -        -","-   --         -          -               ----    ----        -","-   --         -          -               -----  -   -        -","-   --         -          ------     ------   -  -   -        -","-   ------1-----               ---1--         -  -   --- -- ---","-   -----   -                   -   -         -  -      -  -   ","-   -----   -                   -   -         -  -             ","-   -   -   -                   -   -         -  -  - - - -    ","-       -   -                   -   -         -  --- - - - --  ","-   -   -   -                   -   -         -   -         -  ","-   -----   -                   -   -         -   1         -  ","-   -----   -------------       -   -         -   -         -  ","-                -      ---     -   -         ------ - - - --  ","-                1      2 -     -   -               - - - -    ","-                -      ---     -   -                          ","------------------ ------       -   -                          ","          --  -     -      -------1-------                     ","         - 2  -  - -       -    -   -    -                     ","          --     --        -    1   1    -                     ","            - ----         -    -   -    -                     ","            -  -           -    -   -    -                     ","            -  -           ------   ------                     ","            ----           -    -   -    -                     ","                           -    1   1    -                     ","                           -    -   -    -                     ","                           ------   ------                     ","                           -             -                     ","                           -             -                     ","                           -             -                     ","                           ---------------                     "].map(i(r,!1)),objects:["                            -------------                      ","     ------                 -8         8-                      ","     -    -      ------------  a  a  a  -----                  ","     -    -      -          -           -   -                  ","     -     -     - 2    2         6         -                  ","     -     -     -          -           -   -                  ","     ----- ----- -   --------           -----                  ","     -   1 1   - -   -      -           -                      ","     - b     b ---   ---     ----- ------                      ","     -         -       -        -   -                          ","     -c   a        2   -        -   -                          ","     -         -       -        -   -                          ","------ b     b ---------        -   -                          ","-  d--         -                -   -                          ","- 2 ------ ----            ------   ---                        ","-   -   -   -              -         9-                        ","-- --   - 2 -              -  ---   ---                        ","-   -----   -              -  ---   -                          ","- 2 -   -   -              -  ---   -                          ","-     2 - 2 -              ------   -                          ","-   -   -   -                   -   -                          ","-   ------ -----                -- --                ----------","- 2 --         -          ------7   7-------         -    fddd-","-   -- 7     7 -          -7             7--         -       d-","-   --  2   2  -          -               ------------        -","-    -         -          -                -         -        -","-              -          -  6    6    6                      -","-    -         -          -                -         -        -","-   --  2   2  -          -               ----    ----  i  i  -","-   -- 7     7 -          -7             7-----  -   -        -","-   --         -          ------     ------   -  -   -        -","- 2 ------ -----               --- --         -  -   ---h--g---","-   -----   -                   -   -         -  -      -  -   ","-   -----   -                   - 2 -         -  -             ","-   -  e-   -                   -   -         -  -  - - - -    ","-       -   -                   -   -         -  --- - - - --  ","-   -   -   -                   -   -         -   -         -  ","- 2 -----   -                   - 2 -         -             -  ","-   -----   -------------       -   -         -   -        j-  ","-                -      ---     -   -         ------ - - - --  ","-     2       2           -     -   -               - - - -    ","-                -      ---     - 2 -                          ","------------------ ------       -   -                          ","          --  -     -      ------- -------                     ","         -    -  - -       -4   -   -    -                     ","          --     --        -      2   5  -                     ","            - ----         -    -   -    -                     ","            -  -           -    -   -    -                     ","            -  -           ------   ------                     ","            ----           -    -   -    -                     ","                           -   3  2     4-                     ","                           -    -   -    -                     ","                           ------   ------                     ","                           -             -                     ","                           -  2       2  -                     ","                           -             -                     ","                           ---------------                     "].map(i(a,!1,!0)),spriteUrl:"sprites.png"}}(),r={sampleSize:60,value:0,_sample_:[],_index_:0,_lastTick_:!1,tick:function(){if(!this._lastTick_)return this._lastTick_=performance.now(),0;let t=performance.now(),e=1/((t-this._lastTick_)/1e3);this._sample_[this._index_]=Math.round(e);let i=0;for(let t=0;t<this._sample_.length;t++)i+=this._sample_[t];return i=Math.round(i/this._sample_.length),this.value=i,this._lastTick_=t,this._index_++,this._index_===this.sampleSize&&(this._index_=0),this.value}};class a{constructor(t,e=1e3){this.name=t,this.samples=e,this.min=0,this.max=0,this.history=[]}draw(t,e,i,o,r,a,l){const n=this.history.reduce(((t,e)=>Math.max(t,e)),0),s=this.history.reduce(((t,e)=>Math.min(t,e)),n),c=n-s,p=s+c/2,h=this.history.reduce(((t,e)=>t+e),0)/this.history.length,f=.1*l,d=l/8,g=d/2,m=a-(3*g+4*d),y=l/2;t.font=`${d}px monospace`,t.textAlign="right",t.strokeStyle=i,[n,p,s].forEach(((e,i)=>{const l=o+m,n=r+y*i,s=o+a;t.beginPath(),t.moveTo(l,n),t.lineTo(l+g,n),t.stroke(),t.textBaseline=0===i?"top":1===i?"middle":"bottom",t.fillText(`${e.toFixed(2)} MS`,s,n)})),t.fillStyle="#00000099",t.fillRect(o,r,m,l),t.lineWidth=1,t.strokeStyle=i,t.strokeRect(o,r,m,l);const u=(m-2)/this.samples,S=l-1,k=o+1,x=r+S;t.lineWidth=.5,t.strokeStyle=e,t.moveTo(o+1,r+l-1),t.beginPath();for(let e=0;e<this.history.length;e++)t.lineTo(k+u*e,x-(this.history[e]-s)/c*S);t.stroke(),t.font=`${d}px monospace`,t.textAlign="left",t.textBaseline="top",t.fillStyle=i,t.fillText(this.name.toUpperCase()+` (${h.toFixed(2)} MS)`,o+f,r+f)}start(){this.lastP=performance.now()}stop(){const t=performance.now()-this.lastP;this.history.length===this.samples&&this.history.pop(),this.history.unshift(t),this.min=this.history.length>1?Math.min(this.min,t):t,this.max=Math.max(this.max,t)}}const l=Math.PI,n=2*l,s=l/2,c=l/4,p=l/180,h=1440,f=1080,d=75*p,g=320/210/75*51,m=64,y="#fff",u="12px monospace",S=1/3,k=1.5*p,x=[{isFiring:!1,position:0,sprite:[522,523,524,525,526].map((t=>e(t)))},{isFiring:!1,position:0,sprite:[527,528,529,530,531].map((t=>e(t)))},{isFiring:!1,position:0,sprite:[532,533,534,535,536].map((t=>e(t)))},{isFiring:!1,position:0,sprite:[537,538,539,540,541].map((t=>e(t)))}],M={angle:0,speed:0,side:0,weapon:x[0]};let w=JSON.parse(localStorage.getItem("SHOW_FPS"))??!0,b=JSON.parse(localStorage.getItem("SHOW_GRAPHS"))??!0,R=JSON.parse(localStorage.getItem("RENDER_SPRITES"))??!0,_=JSON.parse(localStorage.getItem("RENDER_INTERLACED"))??!0,E=JSON.parse(localStorage.getItem("WALL_COLLISION"))??!0,I=JSON.parse(localStorage.getItem("GAME_DISPLAY"))??1;window.addEventListener("unload",(t=>{localStorage.setItem("player",JSON.stringify($)),localStorage.setItem("SHOW_DEBUG",JSON.stringify(w)),localStorage.setItem("SHOW_GRAPHS",JSON.stringify(b)),localStorage.setItem("RENDER_INTERLACED",JSON.stringify(_)),localStorage.setItem("RENDER_SPRITES",JSON.stringify(R)),localStorage.setItem("GAME_DISPLAY",JSON.stringify(I))}));const O=o,C=O.walls,T=O.pushWalls,v=O.doors,A=O.objects,N=C.map((t=>t.map((t=>0)))),D=new Image;D.src=O.spriteUrl,D.onload=()=>function(){const t=Math.floor($.y),e=Math.floor($.x),i=v[t][e];i&&(i.action=1,i.position=1),z(e,t),requestAnimationFrame(q)}();var P=document.getElementById("canvas");P.width=h,P.height=f;var L=P.getContext("2d");L.imageSmoothingEnabled=!1;let F,W=null;function J(t,e){W=void 0===e?t:`${t} ${e?"ON":"OFF"}`,F&&clearTimeout(F),F=setTimeout((()=>W=null),1500)}const K={up:!1,down:!1,left:!1,right:!1,turbo:!1,stealth:!1,strafe:!1,fire:!1,map:1,action:!1,pause:!1},j={KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",KeyZ:"strafe",KeyX:"fire",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",ShiftLeft:"turbo",Space:"action"},X={Escape:"pause"},Y={Digit1:()=>$.weapon=x[0],Digit2:()=>$.weapon=x[1],Digit3:()=>$.weapon=x[2],Digit4:()=>$.weapon=x[3],Digit5:()=>$.weapon=null,KeyM:()=>{switch(K.map){case 0:case 2:K.map=1;break;case 1:K.map=2}},KeyU:()=>w=!w,KeyG:()=>b=!b,KeyI:()=>J("INTERLACING",_=!_),KeyO:()=>J("SPRITES",R=!R),BracketLeft:()=>J("WALL COLLISION",E=!E),KeyP:()=>J("SMOOTHING",L.imageSmoothingEnabled=!L.imageSmoothingEnabled),KeyR:()=>(J("PLAYER RESET"),$={...M,x:O.spawn.x,y:O.spawn.y},z(Math.floor($.x),Math.floor($.y))),NumpadAdd:()=>I=Math.min(I+1,3),NumpadSubtract:()=>I=Math.max(I-1,1)};document.addEventListener("keydown",(t=>{t.code in j&&(K[j[t.code]]=!0)})),document.addEventListener("keyup",(t=>{console.log(t.code),t.code in j&&(K[j[t.code]]=!1),t.code in X&&(K[X[t.code]]=!K[X[t.code]]),t.code in Y&&Y[t.code]()}));let $=JSON.parse(localStorage.getItem("player"))??{...M,x:O.spawn.x,y:O.spawn.y},B=0,G=performance.now();const H=new a("Calculations"),U=new a("Drawing");function q(){const e=performance.now(),i=e-G;G=e,B++;try{if(!K.pause){const e=720-320*I/2,o=440-210*I/2,a=320*I,p=210*I;let x;H.start(),function(t){(function(t){const e=t/1e3*100;if(K.up&&(K.turbo?$.speed=.1*e:$.speed=.06*e),K.down&&($.speed=-.04*e),K.up||K.down||($.speed=0),K.strafe?(K.left&&($.side=.04*e),K.right&&($.side=-.04*e),K.left||K.right||($.side=0)):$.side=0,K.strafe||(K.left&&($.angle=Z($.angle-k*e)),K.right&&($.angle=Z($.angle+k*e))),K.fire&&!1===$.weapon?.isFiring&&($.weapon.isFiring=!0,$.weapon.position=0),K.action){let t=Math.floor($.x+Math.cos($.angle)),e=Math.floor($.y+Math.sin($.angle)),i=v[e][t];if(i)switch(i.action){case 2:case 4:i.action=3;break;case 1:case 3:i.action=4}let o=T[e][t];if(o&&0===o.action){let i=0,r=0;switch(function(t){for(t+=c;t<0;)t+=n;for(;t>n;)t-=n;return t>3*s?0:t>l?3:t>s?1:2}($.angle)){case 0:i=-1;break;case 1:i=1;break;case 2:r=1;break;case 3:r=-1}C[e+i][t+r]||(o.dirX=r,o.dirY=i,o.position=0,o.action=1)}let r=C[e][t];r&&r.next&&(C[e][t]=r.next),K.action=!1}$.weapon?.isFiring&&($.weapon.position+=t/400,$.weapon.position>=1&&($.weapon.isFiring=!1,$.weapon.position=0));let i=0,o=0;if(0!==$.speed&&(i+=Math.cos($.angle)*$.speed,o+=Math.sin($.angle)*$.speed),0!==$.side&&(i+=Math.sin($.angle)*$.side,o-=Math.cos($.angle)*$.side),0!==i||0!==o)it($.x+i,$.y+o)?($.x+=i,$.y+=o):i&&it($.x+i,$.y)?$.x+=i:o&&it($.x,$.y+o)&&($.y+=o)})(t),function(t){for(let e=0;e<v.length;e++)for(let i=0;i<v[e].length;i++){const o=v[e][i];if(o)switch(o.action){case 1:Math.floor($.x)===i&&Math.floor($.y)===e?o.ticks=0:o.ticks+=t,o.ticks>=2e3&&(o.action=4);break;case 3:if(o.position+=t/1e3,o.position>=1){o.position=1,o.ticks=0,o.action=1;const t=e-Math.floor($.y);z(i+(i-Math.floor($.x)),e+t)}break;case 4:o.position-=t/1e3,o.position<=0&&(o.position=0,o.action=2)}}}(t),function(t){for(let e=0;e<T.length;e++)for(let i=0;i<T[e].length;i++){const o=T[e][i];o&&o.action&&o.action>0&&(o.position+=t/1e3,o.position>=1&&(o.action=0,o.position=0,T[e][i]=void 0,T[e+o.dirY][i+o.dirX]=o,C[e+2*o.dirY][i+2*o.dirX]||T[e+2*o.dirY][i+2*o.dirX]?z(i,e):o.action=1))}}(t)}(i),x=function(t,e){const i=t.angle-d/2,o=d/e,r=[],a=[];for(let t=0;t<C.length;t++){a[t]=[];for(let e=0;e<C[t].length;e++)a[t][e]=0}for(let l=0;l<e;l++){const e=i+o*l,n=tt(e,t),s=et(e,t),c=n.distance>s.distance?s:n;c.cells.forEach((([t,e])=>{a[e][t]=!0})),r.push(c)}return{rays:r,visibleCells:a}}($,a),H.stop(),U.start(),function(e,i,o,a,l,c){L.fillStyle="#004241",_||B>0?(function(t,e,i,o,r){t.clearRect(0,0,h,i),t.clearRect(0,i,e,r),t.clearRect(e+o,i,e,r),t.clearRect(0,i+r,h,i)}(L,o,a,l,c),function(t,e,i,o,r){t.fillRect(0,0,h,i),t.fillRect(0,i,e,r),t.fillRect(e+o,i,h-e+o,r),t.fillRect(0,i+r,h,f-i+r)}(L,o,a,l,c)):(L.clearRect(0,0,h,f),L.fillRect(0,0,h,f),L.fillStyle="black",L.fillRect(o,a,l,c)),function(t,e,i,o,r,a,l,n){t.lineWidth=2,t.strokeStyle="#000000",t.beginPath(),t.moveTo(e-1,i+r+1),t.lineTo(e-1,i-1),t.lineTo(e+o+1,i-1),t.stroke(),t.strokeStyle="#05716e",t.beginPath(),t.moveTo(e+o+1,i-1),t.lineTo(e+o+1,i+r+1),t.lineTo(e-1,i+r+1),t.stroke()}(L,o,a,l,c),L.save(),L.beginPath(),L.rect(o,a,l,c),L.clip(),function(t,e,i,o,r,a){let l=_&&B%2==0?1:0,n=_?2:1;for(;l<e.length;l+=n){const r=e[l],n=a/Q(r.distance,r.angle,$.angle)*g,s=a/2-n/2;t.fillStyle=O.ceiling,t.fillRect(i+l,o+0,1,s),t.fillStyle=O.floor,t.fillRect(i+l,o+s+n,1,s),R&&r.sprite?t.drawImage(D,r.sprite.x+r.spriteX,r.sprite.y,1,m,i+l,o+s,1,n):(t.fillStyle=r.color??"#000",t.fillRect(i+l,o+s,1,n))}}(L,e,o,a,0,c),function(e,i,o,r,a,l,n,s){let c=r.flatMap(((t,e)=>t.filter(((t,i)=>t&&o[e][i]))));c=c.map((e=>[t.distance($.x,$.y,e.x,e.y),e])).sort(((t,e)=>e[0]-t[0])).map((t=>t[1]));for(let o=0;o<c.length;o++){const r=c[o];if(!r)continue;const p=Z($.angle-Math.atan2(r.y-$.y,r.x-$.x)),h=Q(t.distance($.x,$.y,r.x,r.y),$.angle+p,$.angle),f=s/h*g,y=Math.floor(n/2-f/2-p*n/d);let u=null;for(let t=0;t<f;t++)if(y+t>=0&&y+t<i.length&&i[y+t].distance>h)u||(u={sx:r.sprite.x+Math.floor(m/f*t),dx:a+y+t,w:0}),u.w++;else if(u)break;u&&e.drawImage(D,u.sx,r.sprite.y,Math.floor(64/f*u.w),m,u.dx,l+s/2-f/2,u.w,f)}}(L,e,i,A,o,a,l,c),function(t,e,i,o,r,a){if(!e.weapon)return;const l=Math.floor(e.weapon.sprite.length*e.weapon.position),n=e.weapon.sprite[l];t.drawImage(D,n.x,n.y,m,m,i+(r-a)/2,o,a,a)}(L,$,o,a,l,c),L.restore(),K.map>0&&function(e,i,o,r){const a=Math.floor(f/C.length/2),l=i[0].length*a,c=i.length*a,p=Math.floor(720-l/2),d=Math.floor(540-c/2),g=new t($.x,$.y).multiply(a).add(p,d),m=12*a,y=new t(0,0).subtract(g).add(m).add(a,f-2*m-a);r||(e.save(),e.translate(y.x,y.y),e.lineWidth=1,e.strokeStyle="white",e.beginPath(),e.arc(g.x,g.y,m,0,n),e.stroke(),e.clip()),e.globalAlpha=.9,e.fillStyle="#bbb",e.fillRect(0,0,h,f);for(let t=0;t<i.length;t++)for(let o=0;o<i[0].length;o++){if(0===N[t][o])continue;const r=i[t][o],l=T[t][o];r&&(e.fillStyle=r.color,e.fillRect(p+o*a,d+t*a,a,a)),l&&(e.fillStyle=l.color,e.fillRect(p+(o+l.position*l.dirX)*a,d+(t+l.position*l.dirY)*a,a,a))}for(let t=0;t<v.length;t++)for(let o=0;o<v[0].length;o++){const r=v[t][o];r&&0!==N[t][o]&&(e.fillStyle=r.color,i[t-1][o]?e.fillRect(p+o*a+a/3,d+(t+r.position)*a,a/3,a*(1-r.position)):e.fillRect(p+(o+r.position)*a,d+t*a+a/3,a*(1-r.position),a/3))}e.fillStyle="black",e.beginPath(),e.ellipse(g.x,g.y,S*a*2,S*a/3*2,$.angle+s,0,n),e.fill();const u=new t(Math.cos($.angle),Math.sin($.angle)).multiply(S*a*2).add(g);e.strokeStyle="black",e.lineWidth=1,e.beginPath(),e.moveTo(g.x,g.y),e.lineTo(u.x,u.y),e.stroke(),e.fillStyle="orange",e.beginPath(),e.arc(g.x,g.y,S*a/4*2,0,n),e.fill(),e.globalAlpha=1,r||e.restore()}(L,C,0,2===K.map),(w||W)&&(function(t){t.fillStyle="#00000033",t.fillRect(10,10,1420,20)}(L),w&&(function(t){t.font=u,t.fillStyle=y,t.textAlign="left",t.textBaseline="middle",t.fillText(`${$.x.toFixed(0)},${$.y.toFixed(0)} ${$.angle.toFixed(2)}`,20,20)}(L),function(t,e){t.font=u,t.fillStyle=y,t.textAlign="right",t.textBaseline="middle",t.fillText(`${e} FPS`,1420,20)}(L,r.tick())),W&&function(t,e){t.font=u,t.fillStyle=y,t.textAlign="center",t.textBaseline="middle",t.fillText(e,720,20)}(L,W))}(x.rays,x.visibleCells,e,o,a,p),U.stop(),b&&(H.draw(L,"blue","white",470,910,960,75),U.draw(L,"red","white",470,995,960,75))}requestAnimationFrame(q)}catch(t){throw t}}function z(t,e){if(!(e<0||e>=C.length||t<0||t>=C[e].length||N[e][t]>0)){if(N[e][t]=1,C[e][t]||v[e][t]||T[e][t])return C[e][t]&&!V(t+1,e+1,C[0].length,C.length)&&C[e+1][t+1]&&C[e][t+1]&&(N[e][t+1]=1),C[e][t]&&!V(t-1,e-1,C[0].length,C.length)&&C[e-1][t-1]&&C[e-1][t]&&(N[e-1][t]=1),C[e][t]&&!V(t-1,e+1,C[0].length,C.length)&&C[e+1][t-1]&&C[e+1][t]&&(N[e+1][t]=1),C[e][t]&&!V(t+1,e-1,C[0].length,C.length)&&C[e-1][t+1]&&C[e][t+1]&&(N[e][t+1]=1),C[e][t]&&!V(t-1,e-1,C[0].length,C.length)&&C[e-1][t-1]&&C[e][t-1]&&(N[e][t-1]=1),C[e][t]&&!V(t+1,e-1,C[0].length,C.length)&&C[e-1][t+1]&&C[e-1][t]&&(N[e-1][t]=1),void(C[e][t]&&!V(t-1,e+1,C[0].length,C.length)&&C[e+1][t-1]&&C[e][t-1]&&(N[e][t-1]=1));z(t-1,e),z(t+1,e),z(t,e-1),z(t,e+1)}}function Z(t){return t<-l?t+n:t>l?t-n:t}function Q(t,e,i){const o=e-i;return t*Math.cos(o)}function V(t,e,i,o){return t<0||t>=i||e<0||e>=o}function tt(e,i){const o=Math.abs(Math.floor(e/l)%2)>0,r=o?Math.floor(i.y):Math.floor(i.y)+1,a=i.x+(r-i.y)/Math.tan(e),n=o?-1:1,s=n/Math.tan(e),c=s/2,p=c*Math.tan(e);let h,f,d,g,y,u=a,S=r,k=0;const x=[];for(;;){const t=Math.floor(u),i=o?Math.floor(S)-1:Math.floor(S);if(V(t,i,C[0].length,C.length))break;if(h=C[i][t],h){let e=o?v[i+1][t]:v[i-1][t];e?(g=e.frameColor,y=e.frameSprite):(g=h.color,y=h.sprite);break}if(f=T[i][t],f){const i=Math.abs(n)*f.position*f.dirY,o=i/Math.tan(e);if(0===f.action||Math.floor(u+o)===t){g=f.color,y=f.sprite,u+=o,S+=i;break}}if(d=v[i][t],d&&1!==d.action&&(2===d.action||u+c-Math.floor(u+c)>d.position)){g=d.color,y=d.sprite,k=-d.position,u+=c,S+=p;break}x.push([t,i]),u+=s,S+=n}return{angle:e,distance:t.distance(i.x,i.y,u,S),color:g,sprite:y,spriteX:o||d?(k+u-Math.floor(u))*m:(1-k+Math.floor(u)-u)*m,vertical:!1,cells:x}}function et(e,i){const o=Math.abs(Math.floor((e-s)/l)%2)>0,r=o?Math.floor(i.x)+1:Math.floor(i.x),a=i.y+(r-i.x)*Math.tan(e),n=o?1:-1,c=n*Math.tan(e),p=n/2,h=p*Math.tan(e);let f,d,g,y,u,S=r,k=a,x=0;const M=[];for(;;){const t=o?Math.floor(S):Math.floor(S)-1,i=Math.floor(k);if(V(t,i,C[0].length,C.length))break;if(f=C[i][t],f){let e=o?v[i][t-1]:v[i][t+1];e?(y=e.frameDarkColor,u=e.frameDarkSprite):(y=f.darkColor,u=f.darkSprite);break}if(d=T[i][t],d){const t=Math.abs(n)*d.position*d.dirX,o=t*Math.tan(e);if(0===d.action||Math.floor(k+o)===i){y=d.darkColor,u=d.darkSprite,S+=t,k+=o;break}}if(g=v[i][t],g&&1!==g.action&&(2===g.action||k+h-Math.floor(k+h)>g.position)){y=g.darkColor,u=g.darkSprite,x=-g.position,S+=p,k+=h;break}M.push([t,i]),S+=n,k+=c}return{angle:e,distance:t.distance(i.x,i.y,S,k),color:y,sprite:u,spriteX:o||g?(x+k-Math.floor(k))*m:(1-x+Math.floor(k)-k)*m,vertical:!0,cells:M}}function it(t,e){if(!E)return!0;var i=Math.floor(t-S),o=Math.floor(e-S),r=Math.floor(t+S),a=Math.floor(e+S);for(let t=o;t<=a;t++)for(let e=i;e<=r;e++){if(C[t][e])return!1;if(T[t][e])return!1;if(v[t][e]&&1!==v[t][e].action)return!1;if(A[t][e]&&A[t][e].solid)return!1}return!0}})();
//# sourceMappingURL=bundle.d6c8dab636661066.js.map